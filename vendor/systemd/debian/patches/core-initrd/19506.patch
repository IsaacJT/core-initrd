From 7840d7af221944adaa9560ee749d4681106d3586 Mon Sep 17 00:00:00 2001
From: Dimitri John Ledkov <xnox@ubuntu.com>
Date: Tue, 4 May 2021 18:03:04 +0100
Subject: [PATCH 1/5] boot/efi: install ELF linux.elf.stub in addition to PE
 linux.efi.stub

Binutils for non-x86 architectures currently does not support PE binaries. Thus
linux.efi.stub is useless on those, as one cannot use any tooling to add
linux/cmdline/splash sections to it. In addition to PE linux.efi.stub also
install ELF linux.elf.stub, such that one can use objcopy ELF target to copy in
linux/cmdline/splash sections and then convert the result to a PE binary.
---
 src/boot/efi/meson.build | 11 +++++++----
 1 file changed, 7 insertions(+), 4 deletions(-)

Index: systemd/src/boot/efi/meson.build
===================================================================
--- systemd.orig/src/boot/efi/meson.build
+++ systemd/src/boot/efi/meson.build
@@ -210,6 +210,7 @@ if have_gnu_efi
                        '-Bsymbolic',
                        '-nostdlib',
                        '-znocombreloc',
+                       '--build-id=sha1',
                        '-L', efi_libdir,
                        efi_crt0]
         if efi_arch == 'aarch64' or efi_arch == 'arm'
@@ -240,24 +241,22 @@ if have_gnu_efi
 
         libgcc_file_name = run_command(efi_cc + ['-print-libgcc-file-name']).stdout().strip()
         systemd_boot_efi_name = 'systemd-boot@0@.efi'.format(EFI_MACHINE_TYPE_NAME)
+        stub_elf_name = 'linux@0@.elf.stub'.format(EFI_MACHINE_TYPE_NAME)
         stub_efi_name = 'linux@0@.efi.stub'.format(EFI_MACHINE_TYPE_NAME)
         no_undefined_symbols = find_program('no-undefined-symbols.sh')
 
-        foreach tuple : [['systemd_boot.so', systemd_boot_efi_name, systemd_boot_objects],
-                         ['stub.so', stub_efi_name, stub_objects]]
+        efi_stubs = []
+        foreach tuple : [['systemd_boot.so', systemd_boot_efi_name, systemd_boot_objects, false],
+                         [stub_elf_name, stub_efi_name, stub_objects, true]]
                 so = custom_target(
                         tuple[0],
                         input : tuple[2],
                         output : tuple[0],
-                        command : [efi_ld, '-o', '@OUTPUT@'] +
-                                  efi_ldflags + tuple[2] +
-                                  ['-lefi', '-lgnuefi', libgcc_file_name])
-
-                if want_tests != 'false'
-                        test('no-undefined-symbols-' + tuple[0],
-                             no_undefined_symbols,
-                             args : [so])
-                endif
+                        command : [efi_ld, '-o', '@OUTPUT@',
+                                   efi_ldflags, tuple[2],
+                                   '-lefi', '-lgnuefi', libgcc_file_name],
+                        install : tuple[3],
+                        install_dir : bootlibdir)
 
                 stub = custom_target(
                         tuple[1],
@@ -270,22 +269,26 @@ if have_gnu_efi
                                    '-j', '.data',
                                    '-j', '.dynamic',
                                    '-j', '.dynsym',
-                                   '-j', '.rel*']
-                                  + efi_format +
-                                  ['@INPUT@', '@OUTPUT@'],
+                                   '-j', '.rel*',
+                                   efi_format,
+                                   '@INPUT@', '@OUTPUT@'],
                         install : true,
                         install_dir : bootlibdir)
 
-                set_variable(tuple[0].underscorify(), so)
-                set_variable(tuple[0].underscorify() + '_stub', stub)
+                efi_stubs += [[so, stub]]
+
+                if want_tests != 'false'
+                        test('no-undefined-symbols-' + tuple[0],
+                             no_undefined_symbols,
+                             args : so)
+                endif
         endforeach
 
         ############################################################
 
         test_efi_disk_img = custom_target(
                 'test-efi-disk.img',
-                input : [systemd_boot_so, stub_so_stub],
+                input : [efi_stubs[0][0], efi_stubs[1][1]],
                 output : 'test-efi-disk.img',
-                command : [test_efi_create_disk_sh, '@OUTPUT@',
-                           '@INPUT0@', '@INPUT1@', splash_bmp])
+                command : [test_efi_create_disk_sh, '@OUTPUT@','@INPUT@', splash_bmp])
 endif
Index: systemd/test/test-efi-create-disk.sh
===================================================================
--- systemd.orig/test/test-efi-create-disk.sh
+++ systemd/test/test-efi-create-disk.sh
@@ -1,13 +1,13 @@
 #!/usr/bin/env bash
-set -e
+set -eo pipefail
 
-out="$1"
-systemd_efi="$2"
-boot_stub="$3"
-splash_bmp="$4"
-if [ -z "$out" -o -z "$systemd_efi" -o -z "$boot_stub" -o -z "$splash_bmp" ]; then
-    exit 1
-fi
+out="${1:?}"
+systemd_efi="${2:?}"
+boot_stub="${3:?}"
+splash_bmp="${4:?}"
+
+efi_dir="$(bootctl -p)"
+entry_dir="${efi_dir}/$(cat /etc/machine-id)/$(uname -r)"
 
 # create GPT table with EFI System Partition
 rm -f "$out"
@@ -15,15 +15,17 @@ dd if=/dev/null of="$out" bs=1M seek=512
 parted --script "$out" "mklabel gpt" "mkpart ESP fat32 1MiB 511MiB" "set 1 boot on"
 
 # create FAT32 file system
-LOOP=$(losetup --show -f -P "$out")
-mkfs.vfat -F32 ${LOOP}p1
+LOOP="$(losetup --show -f -P "$out")"
+mkfs.vfat -F32 "${LOOP}p1"
 mkdir -p mnt
-mount ${LOOP}p1 mnt
+mount "${LOOP}p1" mnt
 
 mkdir -p mnt/EFI/{BOOT,systemd}
 cp "$systemd_efi" mnt/EFI/BOOT/BOOTX64.efi
 
-[ -e /boot/shellx64.efi ] && cp /boot/shellx64.efi mnt/
+if [ -e /boot/shellx64.efi ]; then
+    cp /boot/shellx64.efi mnt/
+fi
 
 mkdir mnt/EFI/Linux
 echo -n "foo=yes bar=no root=/dev/fakeroot debug rd.break=initqueue" >mnt/cmdline.txt
@@ -31,8 +33,8 @@ objcopy \
     --add-section .osrel=/etc/os-release --change-section-vma .osrel=0x20000 \
     --add-section .cmdline=mnt/cmdline.txt --change-section-vma .cmdline=0x30000 \
     --add-section .splash="$splash_bmp" --change-section-vma .splash=0x40000 \
-    --add-section .linux=/boot/$(cat /etc/machine-id)/$(uname -r)/linux --change-section-vma .linux=0x2000000 \
-    --add-section .initrd=/boot/$(cat /etc/machine-id)/$(uname -r)/initrd --change-section-vma .initrd=0x3000000 \
+    --add-section .linux="${entry_dir}/linux" --change-section-vma .linux=0x2000000 \
+    --add-section .initrd="${entry_dir}/initrd" --change-section-vma .initrd=0x3000000 \
     "$boot_stub" mnt/EFI/Linux/linux-test.efi
 
 # install entries
@@ -48,4 +50,4 @@ echo -e "title Test6\nlinux /test6\n" >
 sync
 umount mnt
 rmdir mnt
-losetup -d $LOOP
+losetup -d "$LOOP"
